---
title: Cálculos y Lógica de Negocio
description: Especificación detallada de la lógica de negocio implementada en las calculadoras de TypeScript.
sidebar:
  label: Cálculos
  order: 3
updated: 2025-12-28
---

import { Tabs, TabItem, Steps } from "@astrojs/starlight/components";

La lógica de negocio de remuneraciones ha sido migrada desde SQL a **TypeScript**, encapsulada en "Calculadoras" puras de dominio. Cada calculadora es una clase estática sin efectos secundarios que resuelve un aspecto específico de la liquidación.

Ubicación del código fuente: `src/domain/payroll/calculators/`

> Para el proceso de consolidación y pago de estas leyes, ver [Generación de Imposiciones](./generacion-imposiciones).

## 1. Sueldo Base (BaseSalaryCalculator)

Determina el sueldo base efectivo a pagar, respetando la proporcionalidad por días trabajados y asegurando el sueldo mínimo.

<Tabs>
  <TabItem label="Reglas de Negocio">
  <Steps>
    1. **Prorrateo**: Se calcula el monto proporcional del sueldo base contrato según los días trabajados.
       ```latex
       SueldoProporcional = \frac{SueldoBase}{30} \times DiasTrabajados
       ```
    2. **Sueldo Mínimo**: Se calcula igualmente el proporcional de la Renta Mínima Mensual (IMM).
    3. **Garantía**: El sistema paga el **MAYOR** valor entre:
       - El proporcional del sueldo pactado.
       - El proporcional del sueldo mínimo legal.

  </Steps>
  
  Esto asegura que si el sueldo base pactado es inferior al mínimo (por error o desactualización), el sistema "floors" el pago al mínimo legal proporcional.
  </TabItem>
  <TabItem label="TypeScript Implementation">
  ```typescript
  // src/domain/payroll/calculators/BaseSalaryCalculator.ts
  export class BaseSalaryCalculator {
    static calculate(contractSalary: number, daysWorked: number, imm: number): number {
      const proportionalSalary = (contractSalary / 30) * daysWorked;
      const proportionalImm = (imm / 30) * daysWorked;
      
      return Math.max(Math.round(proportionalSalary), Math.round(proportionalImm));
    }
  }
  ```
  </TabItem>
</Tabs>

---

## 2. Gratificación Legal (GratificationCalculator)

Calcula el monto de gratificación legal según el artículo 47 o 50 del Código del Trabajo, aplicando los topes legales.

<Tabs>
  <TabItem label="Algoritmo">
  <Steps>
    1. **Calcular Topes**:
       - Tope Anual: `4.75 * IMM`
       - Tope Mensual: `Tope Anual / 12`
    2. **Determinar Monto**:
       - Si es **`abono_anual`** (Art. 50): El monto es igual al Tope Mensual directamente.
       - Si es **`25pct`** (Art. 47):
         - Se calcula el 25% de los haberes imponibles.
         - Se aplica el `MIN(25% Calculado, Tope Mensual)`.
    3. **Prorrateo**: Si el trabajador laboró menos de 30 días, el monto resultante se prorratea.

  </Steps>
  </TabItem>
  <TabItem label="Código Fuente">
  ```typescript
  // src/domain/payroll/calculators/GratificationCalculator.ts
  export class GratificationCalculator {
    static calculate(
        taxableIncome: number, 
        imm: number, 
        mode: '25pct' | 'abono_anual'
    ): number {
      const annualCap = 4.75 * imm;
      const monthlyCap = annualCap / 12;
      
      if (mode === 'abono_anual') return Math.round(monthlyCap);
      
      const legal25 = taxableIncome * 0.25;
      return Math.min(Math.round(legal25), Math.round(monthlyCap));
    }
  }
  ```
  </TabItem>
</Tabs>

---

## 3. Leyes Sociales (SocialLawsCalculator)

Calcula todas las cotizaciones previsionales obligatorias para el trabajador y aportes del empleador.

### Aportes del Trabajador (Descuentos)

<Tabs>
  <TabItem label="AFP">
    `Base Imponible * (10% + Comisión AFP)`. - La base imponible tiene un tope
    (Tope Imponible para Pensiones, ej: 84.3 UF).
  </TabItem>
  <TabItem label="Salud (7%)">
    Ver `HealthPlanCalculator`. Normalmente 7% o Plan Pactado. - Usa el mismo
    tope imponible que la AFP.
  </TabItem>
  <TabItem label="AFC (0.6%)">
    `Base Imponible * 0.6%`. - Tiene su propio tope imponible (Tope AFC, ej:
    126.6 UF), distinto al de pensiones.
  </TabItem>
</Tabs>

---

## 4. Plan de Salud (HealthPlanCalculator)

Resuelve la complejidad de Isapres vs Fonasa y la aplicación del 7% legal.

<Steps>
   1. **Base Imponible**: `MIN(Sueldo Imponible, Tope Legal UF)`.
   2. **FONASA**:
      - El descuento es siempre el **7%** de la base imponible.
      - Ignora cualquier plan pactado.
   3. **ISAPRE**:
      - Calcula el **7% Legal Obligatorio**.
      - Calcula el valor del **Plan Pactado** (UF * ValorUF + CLP).
      - El descuento es: `MAX(7% Legal, Plan Pactado)`.

</Steps>

:::note[Excedentes]
Si el plan es mayor al 7%, el trabajador paga la diferencia. Si es menor, el empleador descuenta el 7% legal y la diferencia genera excedentes en la Isapre (fuera del alcance del motor de nómina, pero el descuento contable es el 7%).
:::

---

## 5. Impuesto Único (TaxCalculator)

Calcula el Impuesto Único de Segunda Categoría (IUSC) aplicado a las rentas del trabajo.

<Steps>
   1. **Base Tributaria**: `Total Imponible - Descuentos Legales (AFP + Salud + AFC) - APV - Otros Descuentos Legales`.
   2. **Determinar Tramo**: Busca en la tabla de impuesto mensual (Service Internal Revenue - SII) el tramo donde cae la base tributaria.
   3. **Cálculo Final**: `Impuesto = (Base Tributaria * Factor) - Rebaja`.
      - Si existen **Créditos** (ej: Donaciones), se restan al impuesto determinado.

</Steps>

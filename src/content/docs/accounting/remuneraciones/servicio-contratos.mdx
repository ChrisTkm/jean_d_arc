---
title: Servicio de Contratos
description: Gesti√≥n del ciclo de vida contractual, compliance laboral y generaci√≥n automatizada de documentos.
sidebar:
  order: 3
updated: 2026-01-05
---

import { Steps, Aside, LinkCard, FileTree } from "@astrojs/starlight/components";

El **Servicio de Contratos** administra la relaci√≥n legal entre la empresa y el colaborador. Es la fuente de verdad para el c√°lculo de remuneraciones (Sueldo Base, Jornada, Antig√ºedad) y es responsable de asegurar el cumplimiento normativo (Compliance) en la documentaci√≥n generada.

<LinkCard
  title="üìò Ver Implementaci√≥n T√©cnica"
  description="ContractService: Creaci√≥n transaccional, PDF Generator y Validadores"
  href="/orchestrator/services/contractservice/"
/>

## Compliance Laboral Asistido üõ°Ô∏è

El sistema no solo almacena datos, sino que act√∫a como un **Auditor de Compliance** previo a la emisi√≥n de documentos. Antes de generar cualquier PDF, el sistema ejecuta las siguientes validaciones estrictas:

| Validaci√≥n | Descripci√≥n | Comportamiento |
| :--- | :--- | :--- |
| **Jornada Obligatoria** | Verifica que el contrato tenga asignada una Jornada de Trabajo activa. | **Bloqueante**: Error si falta jornada. |
| **Previsi√≥n y Salud** | Exige que el empleado tenga **AFP** y **Sistema de Salud** (Fonasa/Isapre) asignados. | **Bloqueante**: Necesario para la Cl√°usula S√©ptima. |
| **Coherencia de Fechas** | Valida que `Fecha T√©rmino > Fecha Inicio` (en contratos a plazo). | **Bloqueante**: Previene contratos con vigencia negativa. |
| **Formato Legal** | Asegura que RUTs y Fechas sigan el formato est√°ndar chileno. | **Autom√°tico**: Formatea datos al vuelo. |

:::note[L√≥gica de Negocio]
Estas reglas est√°n implementadas en el m√©todo `validateCompliance` de `ContractService`. Si alguna falla, se lanza una excepci√≥n `Compliance Error` que impide la descarga o creaci√≥n del documento.
:::

## Generaci√≥n de Documentos (PDF)

El motor de generaci√≥n de contratos transforma los datos estructurados en un documento legalmente v√°lido y est√©ticamente profesional.

### Plantilla Din√°mica Inteligente

El generador (`ContractHtmlGenerator`) adapta las cl√°usulas seg√∫n la configuraci√≥n del contrato:

1.  **Cl√°usula Tercera (Jornada)**:
    *   **Din√°mica**: En lugar de texto est√°tico, obtiene los d√≠as y horas exactos desde la definici√≥n de la Jornada (`WorkingDay`).
    *   **Ejemplo**: _"Lunes a Viernes: de 08:30 a 18:30 horas"_ y _"Con un tiempo de descanso para colaci√≥n de 45 minutos..."_.

2.  **Cl√°usula Quinta (Duraci√≥n)**:
    *   **Indefinido**: Texto _"Duraci√≥n INDEFINIDA"_ y oculta referencias a fechas de t√©rmino.
    *   **Plazo Fijo**: Texto _"Duraci√≥n A PLAZO FIJO"_ e incluye la frase _"terminar√° indefectiblemente el d√≠a [Fecha]"_.

3.  **Cl√°usula S√©ptima (Previsi√≥n)**:
    *   Inyecta autom√°ticamente los nombres de la **AFP** (ej: "Habitat") y **Salud** (ej: "Fonasa") del empleado.

### Self-Healing & Regeneraci√≥n üîÑ

El sistema posee capacidad de autorecuperaci√≥n para los archivos PDF.

*   **Detecci√≥n de Archivos Perdidos**: Al intentar descargar un contrato, si el archivo f√≠sico no existe en el almacenamiento, el sistema **lo regenera autom√°ticamente** al vuelo.
*   **Forzar Regeneraci√≥n**: Desde la UI, el bot√≥n de descarga solicita explicitamente una regeneraci√≥n (`?force=true`) para asegurar que el PDF refleje siempre los √∫ltimos cambios de datos (e.g., cambio de domicilio o sueldo).

```mermaid
sequenceDiagram
    participant User as Usuario
    participant API as /api/contracts/:id/download
    participant Service as ContractService
    participant PDF as HtmlGenerator
    
    User->>API: Click "Descargar PDF"
    API->>Service: getDownloadPath(force=true)
    Service->>Service: validateCompliance()
    alt Compliance OK
        Service->>PDF: Generar HTML (Datos Actualizados)
        PDF-->>Service: Buffer PDF
        Service->>Service: Guardar en Disco
        Service-->>API: Retornar Path
        API-->>User: Archivo PDF
    else Compliance Error
        Service-->>API: Error (Mensaje Validacion)
        API-->>User: Alerta UI
    end
```

## Ciclo de Vida del Contrato

El sistema maneja estados l√≥gicos para alertar sobre la vigencia:

- **VIGENTE**: Fecha t√©rmino futura o indefinida.
- **POR VENCER**: Fecha t√©rmino dentro de los pr√≥ximos 30 d√≠as (Alerta Amarilla).
- **VENCIDO**: Fecha t√©rmino pasada (Alerta Roja).

## Categorizaci√≥n

El campo `categoria_trabajador` define reglas especiales de tributaci√≥n o cotizaci√≥n:

- **DEPENDIENTE**: Regla general.
- **CASA_PARTICULAR**: Reglas especiales de indemnizaci√≥n y AFP.
- **MENOR_MAYOR**: Aprendices o trabajadores j√≥venes.

---
title: Diagramas del Sistema
description: Visualizaci√≥n completa de la arquitectura, flujos de datos y componentes del ecosistema Nostromo
sidebar:
  label: Diagramas
  order: 2
updated: 2026-01-03
---

import { Tabs, TabItem, Aside, Steps, LinkCard, CardGrid } from '@astrojs/starlight/components';

Esta p√°gina contiene los diagramas t√©cnicos del ecosistema Nostromo, mostrando flujos de datos, arquitectura de capas, autenticaci√≥n y despliegue.

---

## Ecosistema Contable (Overview)

El diagrama principal muestra el flujo completo de datos desde servicios externos hasta la base de datos PostgreSQL.

```mermaid
---
title: Ecosistema Contable (Overview)
---
flowchart LR
    %% External Services
    subgraph External["üåê Servicios Externos"]
        SII["SII"]
        PREVIRED["Previred"]
        BC["Banco Central"]
        OPENAI["OpenAI"]
    end

    %% Loaders Layer
    subgraph Loaders["‚öôÔ∏è Python Loaders"]
        BCL["bc_loader.py"]
        I2C["impuesto_2cat_loader.py"]
        PRL["previred_loader.py"]
        SIIL["sii_loader.py"]
        RCS["run_cargas_sii.py"]
    end

    %% Database Layer
    subgraph DB["üóÑÔ∏è Nostromo (PostgreSQL)"]
        direction TB
        
        subgraph Parametros["Schema: Parametros"]
            direction TB
            PAR_MON["Monedas"]
            PAR_IND["Indicadores"]
            PAR_TAX["Impuestos"]
            PAR_AFP["Tasas AFP/AFC"]
        end

        subgraph Operaciones["Schema: Operaciones"]
            OP_COM["Compras"]
            OP_VEN["Ventas"]
            OP_DET["Detalle C/V"]
        end

        subgraph Remuneraciones["Schema: Remuneraciones"]
            REM_EMP["Empleados"]
            REM_CON["Contratos"]
            REM_LIQ["Liquidaciones"]
            REM_HON["Honorarios"]
        end
        
        %% SPs
        SP_CALC(["‚ö° sp_liquidacion_generar"])
        SP_DET(["‚ö° sp_generar_detalle"])
    end

    %% Sevastopol Layer
    subgraph Frontend["üñ•Ô∏è Sevastopol"]
        VIEWS["Islands UI (React)"]
        API["API Clients"]
    end

    %% Connections
    BC -->|API Reference| BCL
    BCL -->|Upsert| PAR_MON

    PREVIRED -->|Scraping| OPENAI
    OPENAI -->|JSON| PRL
    PRL -->|Upsert| PAR_IND & PAR_AFP

    SII -->|Playwright| SIIL & RCS
    SIIL -->|Auth Cookie| RCS
    RCS -->|Insert| OP_COM & OP_VEN
    
    OP_COM & OP_VEN -->|Trigger| SP_DET
    SP_DET -->|Gen| OP_DET

    VIEWS -->|HTTPS/JWT| API
    API -->|SQL/Pool| Remuneraciones
    API -->|Exec| SP_CALC
    SP_CALC -->|Read| REM_EMP & REM_CON & PAR_IND
    SP_CALC -->|Write| REM_LIQ

    %% Styles
    classDef ext fill:#2d2d2d,stroke:#d3095f,stroke-width:2px,color:#fff;
    classDef py fill:#0d1117,stroke:#e3b341,stroke-width:2px,color:#fff;
    classDef db fill:#0d1117,stroke:#2b95d6,stroke-width:2px,color:#fff;
    classDef sp fill:#1f1235,stroke:#8e44ad,stroke-width:2px,stroke-dasharray: 5 5,color:#fff;
    classDef front fill:#0d1117,stroke:#27ae60,stroke-width:2px,color:#fff;

    class SII,PREVIRED,BC,OPENAI ext;
    class BCL,I2C,PRL,SIIL,RCS py;
    class PAR_MON,PAR_IND,PAR_TAX,PAR_AFP,OP_COM,OP_VEN,OP_DET,REM_EMP,REM_CON,REM_LIQ,REM_HON db;
    class SP_CALC,SP_DET sp;
    class VIEWS,API front;
```

### Leyenda de Colores

| Color | Componente | Descripci√≥n |
| :--- | :--- | :--- |
| üü£ Magenta | **Externo** | Servicios fuera de nuestra red (SII, Previred, BC, OpenAI) |
| üü° Amarillo | **Python** | Scripts de extracci√≥n y carga (ETLs) |
| üîµ Cyan | **PostgreSQL** | Tablas y vistas materializadas |
| üü¢ Verde | **Frontend** | Interfaces de usuario en Sevastopol |
| üü£ Violeta | **Stored Proc** | L√≥gica compilada en base de datos |

---

## Flujos de Datos Principales

<Tabs>
  <TabItem label="1. Par√°metros">
    Carga de par√°metros desde servicios externos hacia el schema `parametros`:

    ```mermaid
    flowchart LR
        BC["Banco Central"] -->|API| BCL["bc_loader.py"]
        BCL -->|Inserta| PM["parametros.monedas"]
        
        PR["Previred"] -->|Datos| OAI["OpenAI"]
        OAI -->|JSON| PRL["previred_loader.py"]
        PRL -->|Inserta| PP["parametros.*"]
        
        SII["SII"] -->|Web Scraping| SIIL["sii_loader.py"]
        SIIL -->|Inserta| PI["parametros.impuesto_2cat"]
        
        classDef ext fill:#2d2d2d,stroke:#d3095f,stroke-width:2px,color:#fff;
        classDef py fill:#0d1117,stroke:#e3b341,stroke-width:2px,color:#fff;
        classDef db fill:#0d1117,stroke:#2b95d6,stroke-width:2px,color:#fff;
        
        class BC,PR,SII,OAI ext
        class BCL,PRL,SIIL py
        class PM,PP,PI db
    ```

    <Aside type="tip" title="Scripts Involucrados">
      - `bc_loader.py` - Tipos de cambio (UF, USD, EUR)
      - `previred_loader.py` - Indicadores, topes, AFP/AFC
      - `sii_loader.py` - Tramos de impuesto 2da categor√≠a
    </Aside>
  </TabItem>

  <TabItem label="2. Operaciones">
    Extracci√≥n de compras/ventas del SII hacia el schema `operaciones_sii`:

    ```mermaid
    flowchart LR
        SII["SII"] -->|Extrae datos| RCS["run_cargas_sii.py"]
        RCS -->|Inserta| OPC["operaciones.compras"]
        RCS -->|Inserta| OPV["operaciones.ventas"]
        RCS -->|Inserta| OPB["operaciones.boletas"]
        
        OPC -->|Procesa| SP["sp_generar_compras_ventas_detalle()"]
        OPV -->|Procesa| SP
        
        SP -->|Inserta| CVD["operaciones.compras_ventas_detalle"]
        
        classDef ext fill:#2d2d2d,stroke:#d3095f,stroke-width:2px,color:#fff;
        classDef py fill:#0d1117,stroke:#e3b341,stroke-width:2px,color:#fff;
        classDef sp fill:#1f1235,stroke:#8e44ad,stroke-width:2px,stroke-dasharray: 5 5,color:#fff;
        classDef db fill:#0d1117,stroke:#2b95d6,stroke-width:2px,color:#fff;
        
        class SII ext
        class RCS py
        class SP sp
        class OPC,OPV,OPB,CVD db
    ```

    <Aside type="note" title="Proceso">
      1. `run_cargas_sii.py` extrae datos del SII via Playwright
      2. Inserta en tablas brutas (compras, ventas, boletas)
      3. SP genera detalle consolidado para F29
    </Aside>
  </TabItem>

  <TabItem label="3. Remuneraciones">
    Generaci√≥n de liquidaciones desde el frontend:

    ```mermaid
    flowchart LR
        SEV["Sevastopol UI"] -->|Solicita liquidaci√≥n| ORC["Orchestrator API"]
        
        EMP["remuneraciones.empleados"] -->|Lee datos| SP["sp_liquidacion_generar()"]
        CONT["remuneraciones.contratos"] -->|Lee datos| SP
        
        ORC -->|Ejecuta| SP
        SP -->|Inserta| LIQ["remuneraciones.liquidaciones"]
        
        classDef front fill:#0d1117,stroke:#27ae60,stroke-width:2px,color:#fff;
        classDef sp fill:#1f1235,stroke:#8e44ad,stroke-width:2px,stroke-dasharray: 5 5,color:#fff;
        classDef db fill:#0d1117,stroke:#2b95d6,stroke-width:2px,color:#fff;
        
        class SEV,ORC front
        class SP sp
        class EMP,CONT,LIQ db
    ```

    <Aside type="caution" title="Hybrid Core 2025">
      En la arquitectura actual, los c√°lculos complejos se est√°n migrando a TypeScript (PayrollEngine).
      Los SPs se mantienen para lecturas r√°pidas y agregaciones.
    </Aside>
  </TabItem>
</Tabs>

---

## Flujo de Liquidaci√≥n

El proceso de generaci√≥n de liquidaciones sigue estos pasos:

<Steps>
1. **Sueldo Base Prorrateado** - `fx_sueldo_base_prorrateado()`
2. **C√°lculo de Imposiciones** - `fx_imposiciones()`
3. **Base e Impuesto √önico** - `fx_base_e_impuesto_unico()`
4. **Generaci√≥n de Liquidaci√≥n** - `sp_liquidacion_generar()`
5. **Inserci√≥n de Detalles** - L√≠neas de concepto
6. **Generaci√≥n de Imposiciones** - `sp_generar_imposiciones()`
</Steps>

```mermaid
flowchart TD
    A[Inicio: Generar Liquidaci√≥n] --> B[fx_sueldo_base_prorrateado]
    B --> C[fx_imposiciones]
    C --> D[fx_base_e_impuesto_unico]
    D --> E[sp_liquidacion_generar]
    E --> F[Inserta en liquidaciones]
    F --> G[Inserta en liquidaciones_detalle]
    G --> H[sp_generar_imposiciones]
    H --> I[Fin: Liquidaci√≥n Completa]

    style E stroke:#8e44ad,stroke-width:4px
    style H stroke:#8e44ad,stroke-width:4px
```

---

## Arquitectura de Despliegue

<Tabs>
  <TabItem label="Infraestructura">
    ```mermaid
    graph TD
        subgraph Client["üë§ Cliente"]
            Browser["Navegador Web"]
        end

        subgraph CDN["‚òÅÔ∏è Cloudflare Pages"]
            Static["Jean d'Arc (Docs)"]
            App["Sevastopol (App)"]
        end

        subgraph Backend["üñ•Ô∏è Servidor Node.js"]
            Orchest["Orchestrator API"]
        end

        subgraph Data["üóÑÔ∏è Base de Datos"]
            Neon["PostgreSQL"]
        end

        Browser -->|HTTPS / 443| CDN
        Browser -->|HTTPS / API| Orchest
        Orchest -->|TCP / 5432| Neon
        
        classDef cdn fill:#f39c12,stroke:#d35400,color:#000;
        classDef node fill:#27ae60,stroke:#2ecc71,color:#fff;
        classDef db fill:#16a085,stroke:#1abc9c,color:#fff;
        
        class Static,App cdn;
        class Orchest node;
        class Neon db;
    ```
  </TabItem>

  <TabItem label="Capas">
    ```mermaid
    graph TB
        subgraph Presentaci√≥n
            A[Sevastopol - Astro/Solid]
        end
        subgraph API
            B[Orchestrator - Express/TS]
        end
        subgraph Negocio
            C[Stored Procedures]
            D[Functions]
        end
        subgraph Datos
            E[PostgreSQL - mother]
        end
        
        A -->|HTTP/REST| B
        B -->|SQL| C
        C -->|Llama| D
        C -->|CRUD| E
        D -->|Lee| E
        
        linkStyle 0 stroke:#27ae60,stroke-width:2px;
        linkStyle 1 stroke:#8e44ad,stroke-width:2px;
    ```
  </TabItem>
</Tabs>

---

## Flujo de Autenticaci√≥n

```mermaid
sequenceDiagram
    participant U as üë§ Usuario
    participant F as üèùÔ∏è Sevastopol
    participant A as üéØ Orchestrator
    participant D as üóÑÔ∏è PostgreSQL
    
    U->>F: Ingresa credenciales
    F->>A: POST /auth/login
    A->>D: SELECT * FROM auth.users WHERE email=$1
    D-->>A: User Hash
    A->>A: bcrypt.compare(pass, hash)
    
    alt Credenciales v√°lidas
        A->>A: Generar JWT (sign)
        A-->>F: { token, user_data }
        F->>U: Redirige al Dashboard
    else Inv√°lidas
        A-->>F: 401 Unauthorized
        F->>U: Muestra error
    end
```

<Aside type="note" title="Sesiones">
  El token JWT se almacena en una cookie `sid` (httpOnly, secure).
  Sevastopol lo reenv√≠a autom√°ticamente al Orchestrator via `authenticatedFetch()`.
</Aside>

---

## Integraci√≥n Multi-Tenant

La arquitectura multi-tenant asegura aislamiento de datos por empresa:

```mermaid
graph LR
    A[üë§ Usuario] --> B{üîê Auth}
    B -->|JWT| C[üîÄ Middleware]
    C --> D{üè¢ Tenant?}
    
    subgraph Pools["Pool Cache"]
        D -->|Tenant A| E[Pool nostromo_A]
        D -->|Tenant B| F[Pool nostromo_B]
    end
    
    E --> G[Schema: remuneraciones]
    F --> G
    
    linkStyle 0 stroke:#27ae60,stroke-width:2px;
    linkStyle 1 stroke:#f39c12,stroke-width:2px;
```

<Aside type="caution" title="Regla Cr√≠tica">
  Cada tenant tiene su propia base de datos (`nostromo_{rut}`).
  **Nunca** mezclar conexiones entre tenants.
</Aside>

---

<CardGrid>
  <LinkCard
    title="Sistema Contable"
    description="Documentaci√≥n completa del sistema de contabilidad"
    href="/accounting/sistema-contable/"
  />
  <LinkCard
    title="Endpoints API"
    description="Referencia de APIs del Orchestrator"
    href="/api/endpoints/"
  />
  <LinkCard
    title="Arquitectura Overview"
    description="Visi√≥n general de la arquitectura"
    href="/arquitectura/overview/"
  />
</CardGrid>
